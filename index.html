<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#fce4ec">
  <title>ã‚­ãƒ£ãƒ©ã‚¢ãƒ—ãƒª</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --accent:  #ff6b9d;
      --accent2: #b57bee;
      --bg-from: #ffd6e7;
      --bg-to:   #ddd6fe;
      --bubble:  #ffffff;
      --text:    #333333;
      --muted:   #aaaaaa;
    }

    html { height: 100%; }

    body {
      height: 100dvh;          /* dynamic viewport height â€” keyboard-aware */
      display: flex;
      flex-direction: column;
      font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Noto Sans JP',
                   'YuGothic', sans-serif;
      background: linear-gradient(155deg, var(--bg-from) 0%, var(--bg-to) 100%);
      overflow: hidden;
      max-width: 480px;
      margin: 0 auto;
    }

    /* â”€â”€ LINE notice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #line-notice {
      display: none;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 14px;
      background: #fffde7;
      border-bottom: 2px solid #06c755;
      font-size: 13px;
      line-height: 1.5;
      color: #444;
      position: relative;
      z-index: 10;
    }
    #line-notice .icon { font-size: 20px; flex-shrink: 0; padding-top: 1px; }
    #line-notice .msg  { flex: 1; }
    #line-notice .msg b { color: #06c755; }
    #line-notice button {
      background: none; border: none; font-size: 18px;
      color: #bbb; cursor: pointer; flex-shrink: 0; line-height: 1;
    }

    /* â”€â”€ Character area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #char-area {
      flex: 1;
      min-height: 0;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 12px 24px 0;
    }

    #char-img {
      max-height: 100%;
      max-width: 100%;
      object-fit: contain;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.15));
      animation: floatAnim 4s ease-in-out infinite;
    }

    @keyframes floatAnim {
      0%, 100% { transform: translateY(0); }
      50%       { transform: translateY(-8px); }
    }

    #char-fallback {
      display: none;
      font-size: 110px;
      line-height: 1;
      animation: floatAnim 4s ease-in-out infinite;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.1));
    }

    /* â”€â”€ Speech bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #bubble-wrap {
      padding: 14px 20px 8px;
    }

    #bubble {
      background: var(--bubble);
      border-radius: 22px;
      padding: 14px 18px;
      min-height: 64px;
      font-size: 16px;
      line-height: 1.65;
      color: var(--text);
      box-shadow: 0 6px 20px rgba(0,0,0,.10);
      position: relative;
      word-break: break-all;
    }

    /* Tail pointing up toward character */
    #bubble::before {
      content: '';
      position: absolute;
      top: -9px;
      left: 50%;
      transform: translateX(-50%);
      border: 10px solid transparent;
      border-bottom-color: var(--bubble);
      border-top-width: 0;
    }

    #bubble .placeholder { color: var(--muted); font-size: 14px; }

    /* Speaking pulse dot */
    #speaking-dot {
      display: none;
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--accent);
      vertical-align: middle;
      margin-right: 8px;
      animation: pulseAnim .7s ease-in-out infinite alternate;
    }
    #speaking-dot.active { display: inline-block; }

    @keyframes pulseAnim {
      from { opacity: 1; transform: scale(1);   }
      to   { opacity: .3; transform: scale(.65); }
    }

    /* Bubble pop animation */
    @keyframes bubblePop {
      0%   { transform: scale(.96); opacity: .6; }
      60%  { transform: scale(1.02); }
      100% { transform: scale(1);   opacity: 1; }
    }
    #bubble.pop { animation: bubblePop .3s ease forwards; }

    /* â”€â”€ Bottom controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #controls {
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid rgba(255,255,255,.7);
      padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      gap: 9px;
    }

    /* Voice settings row */
    #voice-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Toggle */
    .toggle-wrap { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
    .toggle-wrap .lbl { font-size: 18px; line-height: 1; }

    .toggle-switch {
      position: relative; width: 42px; height: 24px; flex-shrink: 0;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .ts-track {
      position: absolute; inset: 0;
      background: #ccc; border-radius: 24px;
      cursor: pointer; transition: background .25s;
    }
    .ts-track::after {
      content: '';
      position: absolute;
      width: 18px; height: 18px;
      left: 3px; top: 3px;
      background: #fff;
      border-radius: 50%;
      transition: transform .25s;
      box-shadow: 0 1px 4px rgba(0,0,0,.2);
    }
    .toggle-switch input:checked + .ts-track { background: var(--accent); }
    .toggle-switch input:checked + .ts-track::after { transform: translateX(18px); }

    /* Slider rows */
    .slider-row {
      display: flex; align-items: center; gap: 6px; flex: 1;
    }
    .slider-row .lbl { font-size: 12px; color: #777; white-space: nowrap; }
    .slider-row .val { font-size: 12px; color: #888; width: 28px; text-align: right; flex-shrink: 0; }

    input[type="range"] {
      flex: 1;
      -webkit-appearance: none;
      height: 4px;
      border-radius: 4px;
      background: #e0e0e0;
      outline: none;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px; height: 20px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 2px 8px rgba(255,107,157,.4);
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 20px; height: 20px;
      border: none; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 2px 8px rgba(255,107,157,.4);
      cursor: pointer;
    }

    /* Input row */
    #input-row { display: flex; gap: 8px; }

    #text-input {
      flex: 1;
      padding: 11px 16px;
      border: 2px solid #f5c6de;
      border-radius: 26px;
      font-size: 15px;
      font-family: inherit;
      background: #fff;
      color: var(--text);
      outline: none;
      transition: border-color .2s;
      -webkit-appearance: none;
    }
    #text-input:focus { border-color: var(--accent); }
    #text-input::placeholder { color: #ccc; }

    /* Buttons */
    .btn {
      border: none; border-radius: 26px;
      font-family: inherit; font-weight: 700;
      cursor: pointer; transition: transform .12s, box-shadow .12s;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .btn:active { transform: scale(.94); }

    #send-btn {
      padding: 11px 18px;
      font-size: 14px;
      background: linear-gradient(135deg, var(--accent), #ff8cb8);
      color: #fff;
      box-shadow: 0 4px 14px rgba(255,107,157,.38);
      white-space: nowrap;
    }

    #random-btn {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      background: linear-gradient(135deg, var(--accent2), #818cf8);
      color: #fff;
      box-shadow: 0 4px 14px rgba(181,123,238,.35);
    }
  </style>
</head>
<body>

<!-- LINE in-app browser notice -->
<div id="line-notice">
  <span class="icon">âš ï¸</span>
  <span class="msg">
    LINEãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°èª­ã¿ä¸Šã’ãŒå‹•ä½œã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
    å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ã€Œ<b>ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã</b>ã€ï¼ˆSafari / Chromeï¼‰ã§ãŠè©¦ã—ãã ã•ã„ã€‚
  </span>
  <button onclick="this.parentElement.style.display='none'" aria-label="é–‰ã˜ã‚‹">âœ•</button>
</div>

<!-- Character -->
<div id="char-area">
  <img id="char-img" src="character.png" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼"
       onerror="this.style.display='none';document.getElementById('char-fallback').style.display='block'">
  <div id="char-fallback">ğŸŒ¸</div>
</div>

<!-- Speech bubble -->
<div id="bubble-wrap">
  <div id="bubble">
    <span id="speaking-dot"></span><!--
    --><span id="bubble-text" class="placeholder">ã“ã“ã«ã‚»ãƒªãƒ•ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆï¼</span>
  </div>
</div>

<!-- Controls -->
<div id="controls">

  <!-- Voice toggle + sliders -->
  <div id="voice-row">
    <div class="toggle-wrap">
      <span class="lbl">ğŸ”Š</span>
      <label class="toggle-switch">
        <input type="checkbox" id="speech-toggle" checked>
        <span class="ts-track"></span>
      </label>
    </div>
    <div class="slider-row">
      <span class="lbl">é€Ÿåº¦</span>
      <input type="range" id="rate-slider" min="0.5" max="2.0" step="0.1" value="1.0">
      <span class="val" id="rate-val">1.0</span>
    </div>
    <div class="slider-row">
      <span class="lbl">é«˜ã•</span>
      <input type="range" id="pitch-slider" min="0.5" max="2.0" step="0.1" value="1.2">
      <span class="val" id="pitch-val">1.2</span>
    </div>
  </div>

  <!-- Text input -->
  <div id="input-row">
    <input type="text" id="text-input"
           placeholder="è©±ã—ã‹ã‘ã¦ã¿ã¦ï¼"
           maxlength="200"
           enterkeyhint="send">
    <button class="btn" id="send-btn">é€ä¿¡</button>
  </div>

  <!-- Random phrase -->
  <button class="btn" id="random-btn">âœ¨ ãƒ©ãƒ³ãƒ€ãƒ å°è©</button>

</div>

<script>
'use strict';

/* â”€â”€â”€ Random phrases â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const PHRASES = [
  'ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã‚‚ä¼šãˆã¦å¬‰ã—ã„ãªï½ï¼',
  'ã­ãˆã­ãˆã€ç§ã®ã“ã¨ãšã£ã¨è¦‹ã¦ã¦ã‚ˆã­ï¼Ÿ',
  'ãˆã¸ã¸ã€å‘¼ã‚“ã§ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼',
  'ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã ã£ãŸï¼Ÿèã‹ã›ã¦ã»ã—ã„ãªã€‚',
  'ã¡ã‚‡ã£ã¨ç–²ã‚Œã¦ãªã„ï¼Ÿç„¡ç†ã—ãªã„ã§ã­ã€‚',
  'ã‚ãªãŸã¨ã„ã‚‹ã¨ã€ãªã‚“ã ã‹ã»ã£ã¨ã™ã‚‹ã‚ˆã€‚',
  'é ‘å¼µã£ã¦ã‚‹ã®ã€ã¡ã‚ƒã‚“ã¨çŸ¥ã£ã¦ã‚‹ã‚ˆï¼',
  'ã¾ãŸä¼šãˆãŸï¼ã‚„ã£ãŸãƒ¼ï¼',
  'ä½•ã‹ã‚ã£ãŸã‚‰ã„ã¤ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ï¼',
  'ã†ã‚ãƒ¼ï¼ãã‚Œã™ã”ã„ï¼ã‚‚ã£ã¨æ•™ãˆã¦ï¼',
  'ã„ã£ã—ã‚‡ã«ã„ã‚‹ã¨æ™‚é–“ãŒã‚ã£ã¨ã„ã†é–“ã ã‚ˆã€‚',
  'ã‚ã®ã­â€¦å†…ç·’ã®è©±ãŒã‚ã‚‹ã‚“ã ã‘ã©ã€èã„ã¦ãã‚Œã‚‹ï¼Ÿ',
  'ã¡ã‚ƒã‚“ã¨ã”ã¯ã‚“é£Ÿã¹ãŸï¼Ÿä½“ãŒä¸€ç•ªå¤§äº‹ã ã‚ˆï¼Ÿ',
  'ãŠã‚„ã™ã¿å‰ã«ã²ã¨ã“ã¨è¨€ã„ãŸã‹ã£ãŸã®ã€‚å¤§å¥½ãï¼',
  'ãµãµã€ä»Šæ—¥ã‚‚ã‹ã‚ã„ã„ã­ã€‚',
];

/* â”€â”€â”€ LINE browser detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
if (/Line/i.test(navigator.userAgent)) {
  document.getElementById('line-notice').style.display = 'flex';
}

/* â”€â”€â”€ Speech synthesis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const synth  = window.speechSynthesis;
let   voices = [];
let   speechEnabled = true;
let   audioUnlocked = false;

/** Load / refresh available voices. */
function loadVoices() {
  const v = synth.getVoices();
  if (v.length) voices = v;
}
loadVoices();
synth.onvoiceschanged = loadVoices;

/** Pick best Japanese voice available. */
function getJaVoice() {
  if (!voices.length) loadVoices();
  return (
    voices.find(v => v.lang === 'ja-JP' && v.localService) ||
    voices.find(v => v.lang === 'ja-JP')                   ||
    voices.find(v => v.lang.startsWith('ja'))              ||
    voices[0] || null
  );
}

/**
 * iOS requires the first call to speechSynthesis.speak()
 * to happen synchronously inside a user-gesture handler.
 * We speak a silent empty utterance to "unlock" audio.
 */
function unlockAudio() {
  if (audioUnlocked) return;
  audioUnlocked = true;
  const u = new SpeechSynthesisUtterance('');
  u.volume = 0;
  u.lang = 'ja-JP';
  synth.speak(u);
}
document.addEventListener('touchstart', unlockAudio, { once: true, passive: true });
document.addEventListener('mousedown',  unlockAudio, { once: true });

/* â”€â”€â”€ Bubble UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const bubbleText = document.getElementById('bubble-text');
const bubbleEl   = document.getElementById('bubble');
const dot        = document.getElementById('speaking-dot');
let   isDefault  = true;

function showInBubble(text) {
  if (isDefault) {
    bubbleText.classList.remove('placeholder');
    isDefault = false;
  }
  bubbleText.textContent = text;

  // Pop animation (restart by removing then re-adding class)
  bubbleEl.classList.remove('pop');
  void bubbleEl.offsetWidth;
  bubbleEl.classList.add('pop');
}

/* â”€â”€â”€ Speak â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function speak(text) {
  if (!speechEnabled || !text.trim()) return;
  synth.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.lang  = 'ja-JP';
  u.rate  = parseFloat(document.getElementById('rate-slider').value);
  u.pitch = parseFloat(document.getElementById('pitch-slider').value);
  const voice = getJaVoice();
  if (voice) u.voice = voice;

  dot.classList.add('active');
  u.onend   = () => dot.classList.remove('active');
  u.onerror = () => dot.classList.remove('active');

  synth.speak(u);
}

/* â”€â”€â”€ Action: send text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleSend() {
  unlockAudio();
  const input = document.getElementById('text-input');
  const text  = input.value.trim();
  if (!text) return;
  showInBubble(text);
  speak(text);
  input.value = '';
  input.blur();   // dismiss keyboard on mobile
}

/* â”€â”€â”€ Action: random phrase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleRandom() {
  unlockAudio();
  const text = PHRASES[Math.floor(Math.random() * PHRASES.length)];
  showInBubble(text);
  speak(text);
}

/* â”€â”€â”€ Event listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('send-btn') .addEventListener('click', handleSend);
document.getElementById('random-btn').addEventListener('click', handleRandom);

document.getElementById('text-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleSend();
});

document.getElementById('speech-toggle').addEventListener('change', e => {
  speechEnabled = e.target.checked;
  if (!speechEnabled) { synth.cancel(); dot.classList.remove('active'); }
});

/* â”€â”€â”€ Sliders: display value + filled-track tint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initSlider(sliderId, valId) {
  const sl  = document.getElementById(sliderId);
  const val = document.getElementById(valId);

  function refresh() {
    const pct = ((sl.value - sl.min) / (sl.max - sl.min)) * 100;
    sl.style.background =
      `linear-gradient(to right, var(--accent) ${pct}%, #e0e0e0 ${pct}%)`;
    val.textContent = parseFloat(sl.value).toFixed(1);
  }
  sl.addEventListener('input', refresh);
  refresh();
}
initSlider('rate-slider',  'rate-val');
initSlider('pitch-slider', 'pitch-val');
</script>
</body>
</html>
